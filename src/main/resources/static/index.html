<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .tab { overflow: hidden; border: 1px solid #ccc; background-color: #f1f1f1; }
        .tab button { background-color: inherit; float: left; border: none; outline: none; 
                     cursor: pointer; padding: 14px 16px; transition: 0.3s; }
        .tab button:hover { background-color: #ddd; }
        .tab button.active { background-color: #ccc; }
        .tabcontent { display: none; padding: 20px; border: 1px solid #ccc; border-top: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        input[type="text"], input[type="number"], input[type="date"], select { 
            padding: 6px; margin-right: 10px; }
        button { padding: 6px 12px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
    </style>
</head>
<body>
    <h1>Sistema de Gestión</h1>

    <div class="tab">
        <button class="tablinks active" onclick="openTab(event, 'usuarios')">Usuarios</button>
        <button class="tablinks" onclick="openTab(event, 'coches')">Coches</button>
        <button class="tablinks" onclick="openTab(event, 'reservas')">Reservas</button>
    </div>

    <!-- Pestaña Usuarios -->
    <div id="usuarios" class="tabcontent" style="display: block;">
        <h2>Gestión de Usuarios</h2>
        <form id="usuarioForm" onsubmit="event.preventDefault(); addUsuario();">
            <div class="form-group">
                <input type="text" id="nombre" placeholder="Nombre" required>
                <input type="text" id="apellido" placeholder="Apellido" required>
            </div>
            <div class="form-group">
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Contraseña" required>
            </div>
            <div class="form-group">
                <input type="text" id="tlf" placeholder="Teléfono">
                <input type="date" id="fechaNacimiento">
                <select id="rol">
                    <option value="ADMIN">Admin</option>
                    <option value="CLIENTE">Cliente</option>
                </select>
            </div>
            <button type="submit">Registrar Usuario</button>
        </form>

        <h3>Lista de Usuarios</h3>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Teléfono</th>
                    <th>Rol</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="usuarioTable"></tbody>
        </table>
    </div>

    <!-- Pestaña Coches -->
    <div id="coches" class="tabcontent">
        <h2>Gestión de Coches</h2>
        <form id="cocheForm" onsubmit="event.preventDefault(); addCoche();">
            <div class="form-group">
                <input type="text" id="matricula" placeholder="Matrícula" required>
                <input type="text" id="marca" placeholder="Marca" required>
                <input type="text" id="modelo" placeholder="Modelo" required>
            </div>
            <div class="form-group">
                <input type="number" id="anio" placeholder="Año" min="1900" max="2099" required>
                <input type="text" id="color" placeholder="Color">
                <input type="number" id="precio" placeholder="Precio" step="0.01" required>
                <label>
                    <input type="checkbox" id="disponible"> Disponible
                </label>
            </div>
            <button type="submit">Añadir Coche</button>
        </form>

        <h3>Lista de Coches</h3>
        <table>
            <thead>
                <tr>
                    <th>Matrícula</th>
                    <th>Marca</th>
                    <th>Modelo</th>
                    <th>Año</th>
                    <th>Precio</th>
                    <th>Disponible</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="cocheTable"></tbody>
        </table>
    </div>

    <!-- Pestaña Reservas -->
    <div id="reservas" class="tabcontent">
        <h2>Gestión de Reservas</h2>
        <form id="reservaForm" onsubmit="event.preventDefault(); addReserva();">
            <div class="form-group">
                <select id="usuarioId" required>
                    <option value="">Seleccione usuario</option>
                </select>
                <select id="cocheMatricula" required>
                    <option value="">Seleccione coche</option>
                </select>
            </div>
            <div class="form-group">
                <input type="date" id="fechaReserva" required>
                <input type="number" id="precioTotal" placeholder="Precio Total" step="0.01" required>
                <select id="estadoReserva" required>
                    <option value="PENDIENTE">Pendiente</option>
                    <option value="CONFIRMADA">Confirmada</option>
                    <option value="CANCELADA">Cancelada</option>
                    <option value="FINALIZADA">Finalizada</option>
                </select>
            </div>
            <button type="submit">Crear Reserva</button>
        </form>

        <h3>Lista de Reservas</h3>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Usuario</th>
                    <th>Coche</th>
                    <th>Fecha</th>
                    <th>Precio</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="reservaTable"></tbody>
        </table>
    </div>

    <script>
        // Funciones generales
        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            
            const tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Funciones para Usuarios
        async function fetchUsuarios() {
            const response = await fetch('/api/usuario');
            const usuarios = await response.json();
            
            let tableContent = usuarios.map(usuario => `
                <tr id="usuario-row-${usuario.id}">
                    <td>${usuario.id}</td>
                    <td>${usuario.nombre} ${usuario.apellido}</td>
                    <td>${usuario.email}</td>
                    <td>${usuario.tlf}</td>
                    <td>${usuario.rol}</td>
                    <td>
                        <button onclick="editUsuario(${usuario.id})">Editar</button>
                        <button onclick="deleteUsuario('${usuario.email}')">Eliminar</button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('usuarioTable').innerHTML = tableContent;
            
            // Llenar select de usuarios para reservas
            const usuarioSelect = document.getElementById('usuarioId');
            usuarioSelect.innerHTML = '<option value="">Seleccione usuario</option>' + 
                usuarios.map(u => `<option value="${u.id}">${u.nombre} ${u.apellido}</option>`).join('');
        }

        async function addUsuario() {
            const usuario = {
                nombre: document.getElementById('nombre').value,
                apellido: document.getElementById('apellido').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                tlf: document.getElementById('tlf').value,
                fechaNacimiento: document.getElementById('fechaNacimiento').value,
                rol: document.getElementById('rol').value
            };
            
            await fetch('/api/usuario/registrar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(usuario)
            });
            
            document.getElementById('usuarioForm').reset();
            fetchUsuarios();
        }

        async function deleteUsuario(email) {
            await fetch(`/api/usuario/eliminar?email=${email}`, {
                method: 'DELETE'
            });
            fetchUsuarios();
        }

        // Funciones para Coches
        async function fetchCoches() {
            const response = await fetch('/api/coche');
            const coches = await response.json();
            
            let tableContent = coches.map(coche => `
                <tr id="coche-row-${coche.matricula}">
                    <td>${coche.matricula}</td>
                    <td>${coche.marca}</td>
                    <td>${coche.modelo}</td>
                    <td>${coche.anio}</td>
                    <td>${coche.precio}€</td>
                    <td>${coche.disponible ? 'Sí' : 'No'}</td>
                    <td>
                        <button onclick="editCoche('${coche.matricula}')">Editar</button>
                        <button onclick="deleteCoche('${coche.matricula}')">Eliminar</button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('cocheTable').innerHTML = tableContent;
            
            // Llenar select de coches para reservas
            const cocheSelect = document.getElementById('cocheMatricula');
            cocheSelect.innerHTML = '<option value="">Seleccione coche</option>' + 
                coches.filter(c => c.disponible)
                     .map(c => `<option value="${c.matricula}">${c.marca} ${c.modelo} (${c.matricula})</option>`)
                     .join('');
        }

        async function addCoche() {
            const coche = {
                matricula: document.getElementById('matricula').value,
                marca: document.getElementById('marca').value,
                modelo: document.getElementById('modelo').value,
                anio: parseInt(document.getElementById('anio').value),
                color: document.getElementById('color').value,
                precio: parseFloat(document.getElementById('precio').value),
                disponible: document.getElementById('disponible').checked
            };
            
            await fetch('/api/coche/crear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(coche)
            });
            
            document.getElementById('cocheForm').reset();
            fetchCoches();
        }

        async function deleteCoche(matricula) {
            await fetch(`/api/coche/eliminar?matricula=${matricula}`, {
                method: 'DELETE'
            });
            fetchCoches();
        }

        // Funciones para Reservas
        async function fetchReservas() {
            const response = await fetch('/api/reservas');
            const reservas = await response.json();
            
            let tableContent = reservas.map(reserva => `
                <tr id="reserva-row-${reserva.id}">
                    <td>${reserva.id}</td>
                    <td>${reserva.usuario.nombre} (ID: ${reserva.usuario.id})</td>
                    <td>${reserva.coche.marca} ${reserva.coche.modelo} (${reserva.coche.matricula})</td>
                    <td>${reserva.fecha}</td>
                    <td>${reserva.precioTotal}€</td>
                    <td>${reserva.estado}</td>
                    <td>
                        <button onclick="editReserva(${reserva.id})">Editar</button>
                        <button onclick="deleteReserva(${reserva.id})">Eliminar</button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('reservaTable').innerHTML = tableContent;
        }

        async function addReserva() {
            const reserva = {
                usuario: { id: parseInt(document.getElementById('usuarioId').value) },
                coche: { matricula: document.getElementById('cocheMatricula').value },
                fecha: document.getElementById('fechaReserva').value,
                precioTotal: parseFloat(document.getElementById('precioTotal').value),
                estado: document.getElementById('estadoReserva').value
            };
            
            await fetch('/api/reservas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(reserva)
            });
            
            document.getElementById('reservaForm').reset();
            fetchReservas();
            fetchCoches(); // Actualizar disponibilidad
        }

        async function deleteReserva(id) {
            await fetch(`/api/reservas/${id}`, {
                method: 'DELETE'
            });
            fetchReservas();
            fetchCoches(); // Actualizar disponibilidad
        }

        // Cargar datos iniciales
        window.onload = function() {
            fetchUsuarios();
            fetchCoches();
            fetchReservas();
        };
    </script>
</body>
</html>